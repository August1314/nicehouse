## 环境智控模块开发文档

> 本文档用于规划和管理环境智控模块的开发工作。

---

### 1. 功能模块基本信息

**模块名称：** 环境智控模块

**模块编号：** FM-001

**负责人：** [待分配]

**关联需求：** 基础要求 - 功能项 - 环境智控（舒适 + 智慧）

**核心价值：** 实现"以人为中心"的舒适环境，通过智能监测和自动联动，保持室内空气清新、温度适宜。

---

### 2. 功能模块描述

#### 2.1 功能概述

环境智控模块是"好房子"系统的核心功能之一，主要实现：

- **实时监测**：持续监测各房间的PM2.5、PM10、温度、湿度等环境指标
- **智能联动**：当环境指标超标时，自动开启新风系统、空气净化器、空调等设备
- **手动控制**：提供用户界面，允许用户手动开启/关闭设备，切换自动/手动模式
- **可视化展示**：在UI上实时显示环境数据和设备状态

#### 2.2 核心功能点

- [x] **环境数据监测**：从 `EnvironmentDataStore` 获取实时环境数据
- [ ] **阈值判断**：判断PM2.5、温度等是否超过设定阈值
- [ ] **自动联动**：超标时自动开启新风系统、净化器、空调
- [ ] **设备控制**：控制空调、新风、净化器、风扇的开关和状态
- [ ] **UI面板**：显示环境数据、设备状态、控制按钮
- [ ] **模式切换**：自动模式 / 手动模式切换
- [ ] **设备动画**：设备开启时的动画效果（导风板扫风、扇叶旋转等）

#### 2.3 用户场景

**场景1：PM2.5超标自动净化**
- **触发条件：** 监测到房间PM2.5 > 75 μg/m³
- **用户操作：** 无需操作（自动模式）
- **系统响应：** 
  1. 自动开启空气净化器
  2. 开启新风系统
  3. 在UI上显示"净化中"状态
  4. 记录告警信息

**场景2：温度过高自动制冷**
- **触发条件：** 监测到房间温度 > 28°C
- **用户操作：** 无需操作（自动模式）
- **系统响应：**
  1. 自动开启空调，设定温度26°C
  2. 播放空调导风板扫风动画
  3. 在UI上显示"制冷中"状态

**场景3：手动控制设备**
- **触发条件：** 用户点击UI上的设备控制按钮
- **用户操作：** 点击"开启空调"按钮
- **系统响应：**
  1. 立即开启空调
  2. 更新UI显示设备状态
  3. 开始记录能耗

---

### 3. 设计说明

#### 3.1 架构设计

**模块结构：**
```
EnvironmentControl/
├── Controllers/
│   ├── EnvironmentController.cs      # 核心控制逻辑
│   ├── AirConditionerController.cs  # 空调控制
│   ├── AirPurifierController.cs     # 净化器控制
│   └── FanController.cs              # 风扇控制
├── UI/
│   └── EnvironmentControlPanel.cs    # UI面板
└── Config/
    └── EnvironmentThresholds.cs       # 阈值配置（ScriptableObject）
```

**关键类设计：**

| 类名 | 职责 | 依赖 |
|------|------|------|
| `EnvironmentController` | 环境监测、阈值判断、自动联动 | `EnvironmentDataStore`, `DeviceManager`, `EnergyManager` |
| `EnvironmentControlPanel` | UI显示、按钮事件处理 | `EnvironmentController` |
| `AirConditionerController` | 空调设备控制、动画播放 | `DeviceDefinition`, `EnergyManager` |
| `AirPurifierController` | 净化器设备控制、扇叶旋转 | `DeviceDefinition`, `EnergyManager` |
| `FanController` | 风扇控制、扇叶旋转 | `DeviceDefinition`, `EnergyManager` |

#### 3.2 数据接口依赖

**使用的数据底座接口：**

```csharp
// 获取环境数据
EnvironmentDataStore.Instance.TryGetRoomData(roomId, out var env)

// 获取房间设备
DeviceManager.Instance.GetDevicesInRoom(roomId)

// 设备能耗
EnergyManager.Instance.StartConsume(deviceId)
EnergyManager.Instance.StopConsume(deviceId)

// 告警记录
AlarmManager.Instance.AddAlarm(AlarmType.Smoke, roomId)
```

**参考文档：**
- `docs/data-api-examples.md` - 第2节"环境数据"、第9节"综合示例：环境智控模块"
- `docs/data-quick-reference.md` - EnvironmentDataStore、DeviceManager、EnergyManager

#### 3.3 UI设计

**UI组件：**
- [ ] 主面板（Panel）- 半透明背景，分组显示
- [ ] 环境数据区域
  - 温度显示（大号字体，颜色编码）
  - 湿度显示
  - PM2.5显示（颜色编码：绿/橙/红）
- [ ] 设备控制区域
  - 空调开关按钮 + 状态显示
  - 新风系统开关按钮 + 状态显示
  - 净化器开关按钮 + 状态显示
  - 风扇开关按钮 + 状态显示
- [ ] 模式切换
  - 自动/手动模式切换（Toggle）
- [ ] 设备状态指示
  - 每个设备的状态图标（开启/关闭/运行中）

**布局说明：**
```
┌─────────────────────────────────┐
│  环境智控面板                    │
├─────────────────────────────────┤
│  环境数据                        │
│  Temp: 25.6°C  Humidity: 60%   │
│  PM2.5: 33.7 μg/m³              │
├─────────────────────────────────┤
│  设备控制                        │
│  [空调] [ON]  [新风] [OFF]      │
│  [净化器] [ON] [风扇] [OFF]     │
├─────────────────────────────────┤
│  模式: [自动] [手动]            │
└─────────────────────────────────┘
```

#### 3.4 交互设计

**交互流程：**

1. **自动模式（默认）**
   - 系统每1秒检查一次环境数据
   - 如果超标，自动开启相应设备
   - 用户可以看到设备自动开启的动画和UI反馈

2. **手动模式**
   - 用户点击模式切换为"手动"
   - 自动联动停止
   - 用户通过按钮手动控制设备
   - 每次操作都有UI反馈

3. **设备控制**
   - 点击设备按钮 → 切换设备开关状态
   - 开启时：播放动画、更新UI、开始记录能耗
   - 关闭时：停止动画、更新UI、停止记录能耗

---

### 4. 开发任务

#### 4.1 核心功能开发

**任务 4.1.1：** 实现 EnvironmentController 核心逻辑
- **描述：** 创建环境控制器，实现环境数据监测、阈值判断、自动联动逻辑
- **输入：** 环境数据（从 EnvironmentDataStore）
- **输出：** 设备控制指令、告警记录
- **验收标准：** 
  - 能正确读取环境数据
  - 阈值判断逻辑正确
  - 自动联动触发正确
- **预计工时：** 4小时

**任务 4.1.2：** 实现阈值配置系统
- **描述：** 创建 ScriptableObject 存储各房间的阈值配置（PM2.5、温度等）
- **输入：** 用户配置的阈值
- **输出：** 阈值配置数据
- **验收标准：** 可以在Inspector中配置阈值，代码能读取配置
- **预计工时：** 2小时

**任务 4.1.3：** 实现自动/手动模式切换
- **描述：** 实现模式切换逻辑，自动模式下启用自动联动，手动模式下禁用
- **输入：** 用户切换模式的操作
- **输出：** 模式状态改变
- **验收标准：** 模式切换后，自动联动行为正确改变
- **预计工时：** 2小时

#### 4.2 UI开发

**任务 4.2.1：** 创建环境智控UI面板
- **描述：** 创建UI面板，包含环境数据显示、设备控制按钮、模式切换
- **组件：** Panel、TextMeshPro、Button、Toggle
- **验收标准：** UI布局美观、数据实时更新、按钮交互正常
- **预计工时：** 4小时

**任务 4.2.2：** 实现数据可视化
- **描述：** 环境数据用颜色编码显示（温度、PM2.5等）
- **组件：** TextMeshPro（使用Rich Text）
- **验收标准：** 数据颜色编码正确，视觉效果清晰
- **预计工时：** 2小时

#### 4.3 设备控制开发

**任务 4.3.1：** 实现空调控制器
- **描述：** 控制空调开关，播放导风板扫风动画
- **模型要求：** 空调与墙面分离，导风板单独拆出（见 `docs/interactions.md`）
- **动画/效果：** 导风板左右扫风动画，或出风口粒子特效
- **验收标准：** 空调能正确开启/关闭，动画流畅
- **预计工时：** 3小时

**任务 4.3.2：** 实现净化器控制器
- **描述：** 控制净化器开关，扇叶旋转动画
- **模型要求：** 扇叶与机身分离（见 `docs/interactions.md`）
- **动画/效果：** 扇叶Z轴旋转动画
- **验收标准：** 净化器能正确开启/关闭，扇叶旋转流畅
- **预计工时：** 2小时

**任务 4.3.3：** 实现风扇控制器
- **描述：** 控制风扇开关，扇叶旋转
- **模型要求：** 扇叶与底座分离（见 `docs/interactions.md`）
- **动画/效果：** 扇叶Z轴旋转动画
- **验收标准：** 风扇能正确开启/关闭，扇叶旋转流畅
- **预计工时：** 2小时

**任务 4.3.4：** 实现新风系统控制器
- **描述：** 控制新风系统开关，显示运行状态
- **模型要求：** 新风系统与墙面分离
- **动画/效果：** 运行状态指示（可选：出风口粒子特效）
- **验收标准：** 新风系统能正确开启/关闭
- **预计工时：** 2小时

#### 4.4 测试与优化

**任务 4.4.1：** 功能测试
- **测试用例：**
  1. PM2.5超标时，净化器和新风系统自动开启
  2. 温度过高时，空调自动开启
  3. 手动模式下，自动联动不触发
  4. 设备开关按钮响应正确
  5. UI数据实时更新
- **验收标准：** 所有测试用例通过

**任务 4.4.2：** 性能优化
- **优化点：** 环境数据检查频率、UI更新频率
- **目标：** 保持60 FPS，CPU占用 < 5%

---

### 5. 开发计划

#### 5.1 时间安排（建议）

| 阶段 | 任务 | 开始时间 | 结束时间 | 负责人 |
|------|------|----------|----------|--------|
| 准备 | 需求确认、设计评审 | 第1天 | 第1天 | [姓名] |
| 开发 | EnvironmentController核心逻辑 | 第2天 | 第3天 | [姓名] |
| 开发 | UI面板开发 | 第4天 | 第5天 | [姓名] |
| 开发 | 设备控制器开发 | 第6天 | 第8天 | [姓名] |
| 测试 | 功能测试与优化 | 第9天 | 第10天 | [姓名] |
| 集成 | 与数据底座联调 | 第11天 | 第11天 | [姓名] |

#### 5.2 里程碑

- **M1：** 核心逻辑完成 - 第3天
  - 完成内容：EnvironmentController实现，阈值判断和自动联动逻辑
  
- **M2：** UI完成 - 第5天
  - 完成内容：UI面板完成，数据可视化实现

- **M3：** 设备控制完成 - 第8天
  - 完成内容：所有设备控制器实现，动画效果完成

- **M4：** 模块完成 - 第11天
  - 完成内容：测试通过，与数据底座集成完成

#### 5.3 风险与依赖

**技术风险：**
- [ ] 风险1：模型分割不符合要求 - 应对措施：提前检查模型，必要时手动分割
- [ ] 风险2：动画效果不流畅 - 应对措施：使用Unity Animator或代码控制，优化性能

**依赖项：**
- [x] 依赖1：数据底座完成 - 提供方：数据底座团队 - 状态：已完成
- [ ] 依赖2：模型分割完成 - 提供方：建模团队 - 预计时间：第2天
- [ ] 依赖3：UI设计稿 - 提供方：UI设计 - 预计时间：第1天

---

### 6. 验收标准

#### 6.1 功能完整性

- [ ] 环境数据实时监测正常
- [ ] 阈值判断逻辑正确
- [ ] 自动联动触发正确
- [ ] 手动控制功能正常
- [ ] 模式切换功能正常
- [ ] UI界面完整且美观
- [ ] 设备控制响应正确
- [ ] 设备动画流畅
- [ ] 与数据底座集成正常

#### 6.2 代码质量

- [ ] 代码注释完整
- [ ] 命名规范统一（遵循项目规范）
- [ ] 无编译错误和警告
- [ ] 代码结构清晰，易于维护

#### 6.3 演示准备

- [ ] 功能演示流程清晰（PM2.5超标自动净化、温度过高自动制冷、手动控制）
- [ ] 演示脚本/PPT准备完成
- [ ] 关键功能亮点突出（自动联动、设备动画）

---

### 7. 参考资料

- `docs/interactions.md` - 第1节"环境智控模块"
- `docs/data-api-examples.md` - 第2节"环境数据"、第9节"综合示例：环境智控模块"
- `docs/data-quick-reference.md` - EnvironmentDataStore、DeviceManager、EnergyManager
- `docs/requirements.md` - 作业要求
- `docs/setup.md` - 环境配置说明

---

### 8. 更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2025-01-XX | 1.0 | 初始版本 | [姓名] |

